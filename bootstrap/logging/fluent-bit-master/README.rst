=================================
SENDING LOGS TO AMAZON CLOUDWATCH
=================================

Master nodes and nodes of ``logging`` pool in the management cluster run Fluent Bit configured to
send logs to Amazon CloudWatch Logs service. This allows to keep the logs of the system processes
separate from TestNet worker logs, reducing the load on main Elasticsearch and stripping
irrelevant information from Kibana.

Details
=======

Fluent Bit is deployed as a DaemonSet running a container from official `Amazon For Fluent Bit`_
image. Fluent Bit configuration file is stored in ``fluent-bit-master`` ConfigMap and instructs
Fluent Bit to use ``cloudwatch`` plugin to send the logs to ``spacemesh-testnet-CLUSTERNAME``
group at CloudWatch logs. Master node role is adjusted to allow log stream creation and publishing
for this groups.


Script
------

``update-fb-master.sh`` script can be used to update Fluent Bit configuration on master nodes. If
called without parameters it applies configuration to all the cluster, if called with a single
parameter, cluster type, it applies configuration to all the clusters of type specified, and if
called with cluster type parameter and a list of regions - it applies configuration to all the
clusters of specified type in the given regions.

A common quirk is that changes to ConfigMap are not applied automatically to the running Pods - so
after updating it is required to re-create the running pods as follows::

    kubectl --context=miner-us-east-1 delete pod -l app=fluent-bit-master -n logging


fluent-bit-master DaemonSet
---------------------------

Manifest for Fluent Bit Master DaemonSet resides in ``fb-master-daemonset.yml`` file. It is
identical for all the InitFactory and Miner clusters, and for Management cluster added a
toleration to ``logging`` node pool is added and ``nodeSelector`` to run on master nodes only is
removed.

Besides the ConfigMap, the DaemonSet's Pods mount ``/var/log`` and ``/var/lib/docker/containers``
host directories to be able to reach the log files.


fluent-bit-master ConfigMap
---------------------------

Manifest for Fluent Bit Master ConfigMap is generated by ``get configmap_manifest`` function
defined in ``_fb-master-configmap.tpl.sh`` file. The function accepts two parameters, cluster type
and region, and prints the YAML manifest to standard output, to be consumed by ``kubectl`` via
``-f -`` option.

The ConfigMap contents is identical for all cluster types, with ``aws_region`` and
``spacemesh_cluster`` values varying.



.. _Amazon For Fluent Bit: https://hub.docker.com/r/amazon/aws-for-fluent-bit

.. vim: filetype=rst tw=98 ts=2 sw=2 spell:
